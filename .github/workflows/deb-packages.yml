name: Debian Packages

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: 'nginx version from sid (e.g., 1.28.0-6). Leave blank for latest.'
        required: false
        default: ''
  schedule:
    - cron: '0 2 * * 0'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
      options: --privileged
    outputs:
      nginx_version: ${{ steps.version.outputs.nginx_version }}
      backport_version: ${{ steps.version.outputs.backport_version }}

    steps:
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            devscripts dpkg-dev build-essential fakeroot debhelper \
            curl ca-certificates gnupg lsb-release

      - name: Add sid source repository
        run: |
          echo "deb-src http://deb.debian.org/debian/ sid main" > /etc/apt/sources.list.d/sid-src.list
          apt-get update

      - name: Determine nginx version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.nginx_version }}" ]; then
            VERSION="${{ github.event.inputs.nginx_version }}"
          else
            VERSION=$(apt-cache showsrc nginx 2>/dev/null | grep -m1 "^Version:" | cut -d' ' -f2)
          fi
          echo "nginx_version=$VERSION" >> $GITHUB_OUTPUT
          echo "backport_version=${VERSION}~bpo13+1" >> $GITHUB_OUTPUT

      - name: Download nginx source from sid
        run: |
          mkdir -p /build && cd /build
          apt-get source nginx=${{ steps.version.outputs.nginx_version }}
          NGINX_DIR=$(find . -maxdepth 1 -type d -name "nginx-*" | head -1)
          echo "NGINX_DIR=$NGINX_DIR" >> $GITHUB_ENV

      - name: Install nginx build dependencies
        run: apt-get build-dep -y nginx

      - name: Update changelog for backport
        run: |
          cd /build/$NGINX_DIR
          DEBEMAIL="nginx-backport@localhost" DEBFULLNAME="nginx Backport Bot" \
            dch --bpo "Backport to trixie for SRV record support"

      - name: Build nginx packages
        run: |
          cd /build/$NGINX_DIR
          DEB_BUILD_OPTIONS="nocheck parallel=2" dpkg-buildpackage -us -uc -b

      - name: Install backported nginx for module builds
        run: |
          # Install runtime deps first
          apt-get install -y libbrotli-dev libmaxminddb-dev
          # Install ALL our backported nginx debs (satisfies internal dependencies)
          dpkg -i /build/*.deb || true
          # Fix any remaining deps from trixie repos
          apt-get install -f -y

      - name: Build brotli modules
        run: |
          mkdir -p /build/brotli && cd /build/brotli
          apt-get source libnginx-mod-http-brotli-filter

          BROTLI_DIR=$(find . -maxdepth 1 -type d -name "libnginx-mod-http-brotli*" -o -name "ngx-brotli*" | head -1)
          cd "$BROTLI_DIR"

          DEBEMAIL="nginx-backport@localhost" DEBFULLNAME="nginx Backport Bot" \
            dch --bpo "Backport brotli module to trixie"

          DEB_BUILD_OPTIONS="nocheck parallel=2" dpkg-buildpackage -us -uc -b -d

      - name: Build geoip2 modules
        run: |
          mkdir -p /build/geoip2 && cd /build/geoip2
          apt-get source libnginx-mod-http-geoip2

          GEOIP2_DIR=$(find . -maxdepth 1 -type d -name "libnginx-mod-http-geoip2*" -o -name "ngx-http-geoip2*" | head -1)
          cd "$GEOIP2_DIR"

          DEBEMAIL="nginx-backport@localhost" DEBFULLNAME="nginx Backport Bot" \
            dch --bpo "Backport geoip2 module to trixie"

          DEB_BUILD_OPTIONS="nocheck parallel=2" dpkg-buildpackage -us -uc -b -d

      - name: Collect all debs
        run: |
          mkdir -p /debs
          cp /build/*.deb /debs/ || true
          cp /build/brotli/*.deb /debs/ || true
          cp /build/geoip2/*.deb /debs/ || true
          ls -la /debs/

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ steps.version.outputs.backport_version }}
          path: /debs/*.deb
          retention-days: 90

  create-release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nginx-${{ needs.build.outputs.backport_version }}
          path: ./debs

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.nginx_version }}
          name: nginx ${{ needs.build.outputs.nginx_version }} for Trixie
          body: |
            Backported nginx ${{ needs.build.outputs.nginx_version }} from Debian sid for Trixie.

            Includes:
            - nginx-common, nginx-core, and all standard nginx module packages
            - libnginx-mod-http-brotli-filter and libnginx-mod-http-brotli-static
            - libnginx-mod-http-geoip2 and libnginx-mod-stream-geoip2
          files: ./debs/*.deb
          make_latest: true
