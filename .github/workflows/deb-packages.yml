name: Debian Packages

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if version unchanged'
        type: boolean
        default: false
      skip_upload:
        description: 'Skip upload (for testing build only)'
        type: boolean
        default: false
      version_check_url:
        description: 'URL to check current version (default: https://deb.lichess.ovh/VERSION)'
        type: string
        default: 'https://deb.lichess.ovh/VERSION'
  schedule:
    - cron: '0 2 * * *'  # Nightly at 2 AM UTC

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      nginx_version: ${{ steps.check.outputs.nginx_version }}
      backport_version: ${{ steps.check.outputs.backport_version }}
    steps:
      - name: Get upstream and current versions
        id: check
        run: |
          # Get latest nginx version from sid using docker
          UPSTREAM=$(docker run --rm debian:trixie bash -c "
            apt-get update -qq >/dev/null 2>&1
            echo 'deb-src http://deb.debian.org/debian sid main' > /etc/apt/sources.list.d/sid.list
            apt-get update -qq >/dev/null 2>&1
            apt-cache showsrc nginx 2>/dev/null | grep -m1 '^Version:' | cut -d' ' -f2
          ")

          # Get current version from repo
          VERSION_URL="${{ inputs.version_check_url || 'https://deb.lichess.ovh/VERSION' }}"
          CURRENT=$(curl -sf "$VERSION_URL" || echo "none")

          echo "Upstream: $UPSTREAM"
          echo "Current: $CURRENT"
          echo "nginx_version=$UPSTREAM" >> $GITHUB_OUTPUT
          echo "backport_version=${UPSTREAM}~bpo13+1" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM" != "$CURRENT" ] || [ "${{ inputs.force_build }}" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Build needed: version changed or forced"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "Build skipped: version unchanged"
          fi

  build:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
      options: --privileged

    steps:
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            devscripts dpkg-dev build-essential fakeroot debhelper \
            curl ca-certificates gnupg lsb-release

      - name: Add sid source repository
        run: |
          echo "deb-src http://deb.debian.org/debian/ sid main" > /etc/apt/sources.list.d/sid-src.list
          apt-get update

      - name: Download nginx source from sid
        run: |
          mkdir -p /build && cd /build
          apt-get source nginx=${{ needs.check-version.outputs.nginx_version }}
          NGINX_DIR=$(find . -maxdepth 1 -type d -name "nginx-*" | head -1)
          echo "NGINX_DIR=$NGINX_DIR" >> $GITHUB_ENV

      - name: Install nginx build dependencies
        run: apt-get build-dep -y nginx

      - name: Update changelog for backport
        run: |
          cd /build/$NGINX_DIR
          DEBEMAIL="nginx-backport@localhost" DEBFULLNAME="nginx Backport Bot" \
            dch --bpo "Backport to trixie for SRV record support"

      - name: Build nginx packages
        run: |
          cd /build/$NGINX_DIR
          DEB_BUILD_OPTIONS="nocheck parallel=2" dpkg-buildpackage -us -uc -b

      - name: Install backported nginx for module builds
        run: |
          apt-get install -y libbrotli-dev libmaxminddb-dev
          dpkg -i /build/*.deb || true
          apt-get install -f -y

      - name: Build brotli modules
        run: |
          mkdir -p /build/brotli && cd /build/brotli
          apt-get source libnginx-mod-http-brotli-filter

          BROTLI_DIR=$(find . -maxdepth 1 -type d -name "libnginx-mod-http-brotli*" -o -name "ngx-brotli*" | head -1)
          cd "$BROTLI_DIR"

          DEBEMAIL="nginx-backport@localhost" DEBFULLNAME="nginx Backport Bot" \
            dch --bpo "Backport brotli module to trixie"

          DEB_BUILD_OPTIONS="nocheck parallel=2" dpkg-buildpackage -us -uc -b -d

      - name: Build geoip2 modules
        run: |
          mkdir -p /build/geoip2 && cd /build/geoip2
          apt-get source libnginx-mod-http-geoip2

          GEOIP2_DIR=$(find . -maxdepth 1 -type d -name "libnginx-mod-http-geoip2*" -o -name "ngx-http-geoip2*" | head -1)
          cd "$GEOIP2_DIR"

          DEBEMAIL="nginx-backport@localhost" DEBFULLNAME="nginx Backport Bot" \
            dch --bpo "Backport geoip2 module to trixie"

          DEB_BUILD_OPTIONS="nocheck parallel=2" dpkg-buildpackage -us -uc -b -d

      - name: Collect all debs
        run: |
          mkdir -p /debs
          cp /build/*.deb /debs/ || true
          cp /build/brotli/*.deb /debs/ || true
          cp /build/geoip2/*.deb /debs/ || true
          ls -la /debs/

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ needs.check-version.outputs.backport_version }}
          path: /debs/*.deb
          retention-days: 30

  publish-repo:
    needs: [check-version, build]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nginx-${{ needs.check-version.outputs.backport_version }}
          path: ./debs

      - name: Install apt-utils
        run: sudo apt-get update && sudo apt-get install -y apt-utils

      - name: Generate repository structure
        run: |
          mkdir -p repo/pool/main/n/nginx
          mkdir -p repo/dists/trixie/main/binary-amd64

          # Copy debs to pool, excluding dbgsym
          for f in debs/*.deb; do
            [[ "$f" == *dbgsym* ]] && continue
            cp "$f" repo/pool/main/n/nginx/
          done

          # Generate Packages file
          cd repo
          apt-ftparchive packages pool > dists/trixie/main/binary-amd64/Packages
          gzip -k dists/trixie/main/binary-amd64/Packages

          # Generate Release file
          apt-ftparchive release dists/trixie > dists/trixie/Release

          # Write version marker
          echo "${{ needs.check-version.outputs.nginx_version }}" > VERSION

          echo "Repository contents:"
          find . -type f

      - name: Upload to deb server
        if: ${{ inputs.skip_upload != true }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEB_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.DEB_SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          rsync -avz --delete repo/ ${{ secrets.DEB_SSH_USER }}@${{ secrets.DEB_SSH_HOST }}:${{ secrets.DEB_SSH_PATH || '/var/www/deb/' }}
